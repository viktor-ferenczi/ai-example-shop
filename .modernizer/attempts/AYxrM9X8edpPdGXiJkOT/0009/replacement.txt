[Authorize]
        [HttpPost]
        public async Task<IActionResult> SaveProfile(AccountSettingsModel model)
        {
            GetRoles();
            if (ModelState.IsValid)
            {
                var user = await _userManager.FindByEmailAsync(model.Email);
                UpdateUser(model, user);

                if (PasswordChangeRequired(model))
                {
                    if (!PasswordChangeSucceeded(model, user))
                    {
                        ModelState.AddModelError("OldPassword", "Incorrect password, please enter your current password to change it");
                        return View("Settings", model);
                    }
                }

                if (RoleChangeRequired(model, user))
                {
                    await UpdateUserRole(model, user);
                }

                await _userManager.UpdateAsync(user);

                await HttpContext.RefreshLoginAsync();

                if (User.IsInRole("Admin"))
                {
                    return RedirectToAction("Profile", new { userId = user.Id });
                }
                return RedirectToAction("Profile");
            }
            return View("Settings", model);
        }

        private void GetRoles()
        {
            var roles = _roleManager.Roles.Select(role => new RoleDropdownModel
            {
                Id = role.Id,
                Name = role.Name
            });
            ViewBag.Roles = new SelectList(roles, "Id", "Name");
        }

        private void UpdateUser(AccountSettingsModel model, ApplicationUser user)
        {
            _mapper.AccountSettingsModelToApplicationUser(model, user);
        }

        private bool PasswordChangeRequired(AccountSettingsModel model)
        {
            return !string.IsNullOrEmpty(model.OldPassword)
                    || !string.IsNullOrEmpty(model.NewPassword)
                    || !string.IsNullOrEmpty(model.NewPasswordConfirmation);
        }

        private async Task<bool> PasswordChangeSucceeded(AccountSettingsModel model, ApplicationUser user)
        {
            var result = await _userManager.ChangePasswordAsync(user, model.OldPassword ?? "", model.NewPassword ?? "");
            return result.Succeeded;
        }

        private bool RoleChangeRequired(AccountSettingsModel model, ApplicationUser user)
        {
            string roleName = (await _userManager.GetRolesAsync(user)).FirstOrDefault();
            string roleId = _roleManager.Roles.FirstOrDefault(role => role.Name == roleName).Id;
            return roleId != model.RoleId;
        }

        private async Task UpdateUserRole(AccountSettingsModel model, ApplicationUser user)
        {
            string role = _roleManager.Roles.First(r => r.Id == model.RoleId).Name;
            var userRole = (await _userManager.GetRolesAsync(user)).FirstOrDefault();
            await _userManager.RemoveFromRoleAsync(user, userRole);
            await _userManager.AddToRoleAsync(user, role);
        }
